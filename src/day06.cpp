#include "advent2021.h"

output_t day06(input_t in) {
	constexpr uint64_t P0 = 90053143, P1 = 96987173;

	constexpr uint64_t M0[9][5] = {
		{ 45613180, 10992145, 36799095, 89051706,  7600020 },
		{ 64119455, 54691107, 67663637, 18347369, 78624105 },
		{ 24361600, 82436665, 54465988, 64729193, 67851617 },
		{ 22025729, 23514570, 58478108, 85091742, 18068727 },
		{ 76227074, 23392312, 34109155, 44124427, 73920125 },
		{ 13500891, 38891102,  5088320, 24040030, 73693061 },
		{ 29276729, 34344984, 17231370, 28642082, 72859808 },
		{ 87609939, 87498035, 27071447, 83699130,  1438646 },
		{ 87531119,  4451653, 59305453, 12540037, 56209607 },
	};

	constexpr uint64_t M1[9][5] = {
		{ 52443183, 24294606, 51639288, 91867425, 80843140 },
		{  7802469,  1746509, 68428933, 59893050,  2271862 },
		{ 79479175, 93954942, 51658309,  2359895, 82291517 },
		{ 22154754, 30113332, 23168392, 39205757, 82520897 },
		{ 47734597, 96709240, 22077798, 65766344, 47715919 },
		{  9389227, 31557321, 93602158, 45689043, 63904673 },
		{ 52748265,  2328802, 86302172,  3313387, 79876071 },
		{ 39303708, 68677182, 51589832,  3716199, 44846162 },
		{ 76893315, 38566759, 36468984, 76137593,   665625 },
	};

	constexpr uint64_t E80_0[] = {
		69374324, 57200857, 74546123, 24187188, 77665823,
		17700331, 16235274, 26822369, 86535442 };

	constexpr uint64_t E256_0[] = {
		 6252279, 63527937, 62417562, 74999346, 24313800,
		54248490, 25233944,  3824363, 43259421 };

	constexpr uint64_t E256_1[] = {
		37697784, 24004563, 80205402, 24444212, 11184247,
		43260176, 72993835, 71427520,  6370475 };

	uint64_t count[8] = { };
	for (; in.len > 0; parse::skip(in, 2)) {
		count[(*in.s - 1) & 7]++;
	}

	auto dot = [](int n, auto u, auto v) {
		return std::inner_product(&u[0], &u[n], &v[0], uint64_t(0));
	};

	uint64_t C0[9], C1[9];
	std::transform(&M0[0], &M0[9], &C0[0], std::bind_front(dot, 5, count));
	std::transform(&M1[0], &M1[9], &C1[0], std::bind_front(dot, 5, count));

	auto part1 = dot(9, C0, E80_0 ) % P0;

	// Who said we couldn't have CRT in 2021?
	auto part2 = dot(9, C0, E256_0) % P0 * 36360494 % P0 * P1
		   - dot(9, C1, E256_1) % P1 * 39160227 % P1 * P0;

	return { part1, part2 };
}
